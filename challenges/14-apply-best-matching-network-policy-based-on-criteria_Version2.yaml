id: 14-apply-best-matching-network-policy-based-on-criteria_Version2
title: Apply the best matching NetworkPolicy given criteria.
category: networkpolicy
namespace: 14-apply-best-matching-network-policy-based-on-criteria-version2
timeLimitSeconds: 900
setup: ../scripts/challenges/setup-networkpolicy.sh
grade: ../grading/grade-networkpolicy.sh
description: |
  Task: Apply the best matching NetworkPolicy given criteria.
  
  Common patterns:
  
  1) Default deny all ingress/egress in a namespace
  cat <<'EOF' | kubectl apply -f -
  apiVersion: networking.k8s.io/v1
  kind: NetworkPolicy
  metadata:
    name: default-deny-all
    namespace: target-ns
  spec:
    podSelector: {}
    policyTypes: ["Ingress","Egress"]
  EOF
  
  2) Allow ingress to app pods from frontend namespace on HTTP only
  cat <<'EOF' | kubectl apply -f -
  apiVersion: networking.k8s.io/v1
  kind: NetworkPolicy
  metadata:
    name: allow-frontend-to-app-http
    namespace: target-ns
  spec:
    podSelector:
      matchLabels:
        app: myapp
    policyTypes: ["Ingress"]
    ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            name: frontend
      - podSelector:
          matchLabels:
            role: frontend
      ports:
      - protocol: TCP
        port: 80
  EOF
  
  3) Allow app egress only to DNS and database
  cat <<'EOF' | kubectl apply -f -
  apiVersion: networking.k8s.io/v1
  kind: NetworkPolicy
  metadata:
    name: restrict-egress
    namespace: target-ns
  spec:
    podSelector:
      matchLabels:
        app: myapp
    policyTypes: ["Egress"]
    egress:
    - to:
      - namespaceSelector: {}   # kube-system for DNS if labeled; adjust as needed
      ports:
      - protocol: UDP
        port: 53
      - protocol: TCP
        port: 53
    - to:
      - podSelector:
          matchLabels:
            app: db
      ports:
      - protocol: TCP
        port: 5432
  EOF
  
  Verification:
  - Label namespaces as required (e.g., kubectl label ns frontend name=frontend).
  - Test connectivity with busybox curls and DNS lookups.
