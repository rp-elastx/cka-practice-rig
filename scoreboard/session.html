<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CKA Practice Session</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  color: #fff;
}
.layout {
  display: flex;
  height: 100vh;
}
.sidebar {
  width: 380px;
  min-width: 320px;
  background: rgba(0, 0, 0, 0.4);
  border-right: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.sidebar-header {
  padding: 1rem;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  align-items: center;
  gap: 0.5rem;
  flex-shrink: 0;
}
.sidebar-header .logo { font-size: 1.5rem; }
.sidebar-header h1 {
  font-size: 1.1rem;
  font-weight: 300;
}
.sidebar-header h1 span { font-weight: 700; color: #326ce5; }
.sidebar-content {
  flex: 1;
  overflow-y: auto;
  padding: 1rem;
}
.timer-bar {
  background: rgba(0, 0, 0, 0.3);
  padding: 0.75rem 1rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  flex-shrink: 0;
}
.timer-label { font-size: 0.75rem; color: #888; text-transform: uppercase; }
.timer-value {
  font-size: 1.4rem;
  font-weight: 700;
  font-family: 'Monaco', 'Menlo', monospace;
}
.timer-value.ok { color: #2ecc71; }
.timer-value.warning { color: #f39c12; }
.timer-value.danger { color: #e74c3c; }
.stats-bar {
  display: flex;
  gap: 1rem;
  padding: 0.5rem 1rem;
  background: rgba(0, 0, 0, 0.2);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
  flex-shrink: 0;
}
.stat { text-align: center; flex: 1; }
.stat-value { font-size: 1.2rem; font-weight: 700; color: #326ce5; }
.stat-label { font-size: 0.65rem; color: #888; text-transform: uppercase; }
.challenge-section { margin-bottom: 1rem; }
.challenge-title {
  font-size: 1.1rem;
  font-weight: 600;
  color: #326ce5;
  margin-bottom: 0.5rem;
}
.challenge-meta {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 0.75rem;
  flex-wrap: wrap;
}
.meta-item {
  background: rgba(255, 255, 255, 0.1);
  padding: 0.25rem 0.5rem;
  border-radius: 4px;
  font-size: 0.75rem;
}
.meta-item code {
  color: #2ecc71;
  font-family: 'Monaco', 'Menlo', monospace;
}
.description-box {
  background: rgba(0, 0, 0, 0.3);
  border-radius: 8px;
  padding: 0.75rem;
  font-size: 0.85rem;
  line-height: 1.6;
  white-space: pre-wrap;
  color: #ddd;
  max-height: 250px;
  overflow-y: auto;
}
.section-title {
  font-size: 0.7rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #888;
  margin: 1rem 0 0.5rem 0;
}
.docs-links {
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
}
.doc-link {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  color: #aaa;
  text-decoration: none;
  padding: 0.4rem 0.6rem;
  background: rgba(50, 108, 229, 0.1);
  border-radius: 6px;
  font-size: 0.8rem;
  transition: all 0.2s;
}
.doc-link:hover { background: rgba(50, 108, 229, 0.2); color: #fff; }
.doc-link .url {
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  color: #326ce5;
}
.copy-btn {
  background: rgba(255,255,255,0.1);
  border: none;
  color: #888;
  padding: 0.2rem 0.4rem;
  border-radius: 4px;
  cursor: pointer;
  font-size: 0.7rem;
}
.copy-btn:hover { background: rgba(255,255,255,0.2); color: #fff; }
.copy-btn.copied { background: #27ae60; color: #fff; }
.actions-bar {
  padding: 0.75rem;
  background: rgba(0, 0, 0, 0.3);
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  flex-shrink: 0;
}
.btn {
  padding: 0.5rem 0.75rem;
  font-size: 0.8rem;
  font-weight: 600;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.2s ease;
  display: inline-flex;
  align-items: center;
  gap: 0.3rem;
}
.btn-success { background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%); color: #fff; }
.btn-warning { background: linear-gradient(135deg, #f39c12 0%, #d68910 100%); color: #fff; }
.btn-secondary { background: rgba(255,255,255,0.1); color: #fff; border: 1px solid rgba(255,255,255,0.2); }
.btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: #fff; }
.btn-primary { background: linear-gradient(135deg, #326ce5 0%, #1e4db7 100%); color: #fff; }
.btn:hover { transform: translateY(-1px); }
.btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
.btn-sm { padding: 0.35rem 0.5rem; font-size: 0.7rem; }
.message {
  padding: 0.5rem;
  border-radius: 6px;
  font-size: 0.8rem;
  margin-bottom: 0.5rem;
}
.message.success { background: rgba(39,174,96,0.2); border: 1px solid rgba(39,174,96,0.3); color: #2ecc71; }
.message.error { background: rgba(231,76,60,0.2); border: 1px solid rgba(231,76,60,0.3); color: #e74c3c; }
.message:empty { display: none; }
.main {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #000;
}
.desktop-frame {
  flex: 1;
  border: none;
  width: 100%;
  height: 100%;
}
.no-session {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 100%;
  color: #888;
  text-align: center;
  padding: 2rem;
}
.no-session .icon { font-size: 3rem; margin-bottom: 1rem; }
.no-session h2 { color: #fff; margin-bottom: 0.5rem; font-size: 1.2rem; }
.no-session p { margin-bottom: 1rem; font-size: 0.9rem; }
.toggle-sidebar {
  position: fixed;
  left: 380px;
  top: 50%;
  transform: translateY(-50%);
  background: rgba(0,0,0,0.5);
  border: 1px solid rgba(255,255,255,0.2);
  color: #fff;
  padding: 0.5rem 0.25rem;
  border-radius: 0 6px 6px 0;
  cursor: pointer;
  z-index: 100;
  font-size: 0.8rem;
}
.toggle-sidebar:hover { background: rgba(50,108,229,0.5); }
.sidebar.collapsed { width: 0; min-width: 0; padding: 0; overflow: hidden; }
.sidebar.collapsed + .main .toggle-sidebar { left: 0; }
.back-link {
  color: #666;
  text-decoration: none;
  font-size: 0.75rem;
  padding: 0.5rem 1rem;
  display: block;
  border-bottom: 1px solid rgba(255,255,255,0.05);
}
.back-link:hover { color: #326ce5; }
</style>
</head>
<body>
<div class="layout">
  <div class="sidebar" id="sidebar">
    <a href="/" class="back-link">‚Üê Back to Home</a>
    
    <div class="timer-bar">
      <div>
        <div class="timer-label">‚è±Ô∏è Time Remaining</div>
        <div class="timer-value ok" id="sessionCountdown">2:00:00</div>
      </div>
      <a href="scoreboard/index.html" target="_blank" class="btn btn-sm btn-secondary">üìä</a>
    </div>
    
    <div class="stats-bar">
      <div class="stat">
        <div class="stat-value" id="currentNum">-</div>
        <div class="stat-label">Current</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="completedCount">0</div>
        <div class="stat-label">Done</div>
      </div>
      <div class="stat">
        <div class="stat-value" id="passedCount">0</div>
        <div class="stat-label">Passed</div>
      </div>
    </div>
    
    <div class="sidebar-content">
      <div id="actionMsg" class="message success"></div>
      <div id="errorMsg" class="message error"></div>
      
      <div id="challenge-panel">
        <div class="no-session">
          <div class="icon">üìã</div>
          <p>Loading...</p>
        </div>
      </div>
    </div>
    
    <div class="actions-bar" id="actions-bar">
      <button id="startBtn" class="btn btn-primary">‚ñ∂ Start Session</button>
      <button id="doneBtn" class="btn btn-success" style="display:none;">‚úì Grade</button>
      <button id="nextBtn" class="btn btn-warning" style="display:none;">‚Üí Next</button>
      <button id="resetBtn" class="btn btn-danger btn-sm" style="display:none;">‚ü≤ Reset</button>
    </div>
  </div>
  
  <button class="toggle-sidebar" id="toggleBtn">‚óÄ</button>
  
  <div class="main">
    <iframe id="desktopFrame" class="desktop-frame" src="about:blank"></iframe>
  </div>
</div>

<script>
const docsMap = {
  'pod': ['https://kubernetes.io/docs/concepts/workloads/pods/', 'Pods'],
  'deployment': ['https://kubernetes.io/docs/concepts/workloads/controllers/deployment/', 'Deployments'],
  'service': ['https://kubernetes.io/docs/concepts/services-networking/service/', 'Services'],
  'ingress': ['https://kubernetes.io/docs/concepts/services-networking/ingress/', 'Ingress'],
  'configmap': ['https://kubernetes.io/docs/concepts/configuration/configmap/', 'ConfigMaps'],
  'secret': ['https://kubernetes.io/docs/concepts/configuration/secret/', 'Secrets'],
  'pv': ['https://kubernetes.io/docs/concepts/storage/persistent-volumes/', 'Persistent Volumes'],
  'pvc': ['https://kubernetes.io/docs/concepts/storage/persistent-volumes/#persistentvolumeclaims', 'PVCs'],
  'storage': ['https://kubernetes.io/docs/concepts/storage/', 'Storage'],
  'storageclass': ['https://kubernetes.io/docs/concepts/storage/storage-classes/', 'StorageClasses'],
  'rbac': ['https://kubernetes.io/docs/reference/access-authn-authz/rbac/', 'RBAC'],
  'serviceaccount': ['https://kubernetes.io/docs/concepts/security/service-accounts/', 'Service Accounts'],
  'networkpolicy': ['https://kubernetes.io/docs/concepts/services-networking/network-policies/', 'Network Policies'],
  'netpol': ['https://kubernetes.io/docs/concepts/services-networking/network-policies/', 'Network Policies'],
  'hpa': ['https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/', 'HPA'],
  'scale': ['https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/', 'Autoscaling'],
  'taint': ['https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/', 'Taints & Tolerations'],
  'toleration': ['https://kubernetes.io/docs/concepts/scheduling-eviction/taint-and-toleration/', 'Taints & Tolerations'],
  'affinity': ['https://kubernetes.io/docs/concepts/scheduling-eviction/assign-pod-node/', 'Node Affinity'],
  'node': ['https://kubernetes.io/docs/concepts/architecture/nodes/', 'Nodes'],
  'drain': ['https://kubernetes.io/docs/tasks/administer-cluster/safely-drain-node/', 'Drain Nodes'],
  'cordon': ['https://kubernetes.io/docs/reference/kubectl/generated/kubectl_cordon/', 'Cordon'],
  'etcd': ['https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/', 'etcd'],
  'backup': ['https://kubernetes.io/docs/tasks/administer-cluster/configure-upgrade-etcd/#backing-up-an-etcd-cluster', 'etcd Backup'],
  'upgrade': ['https://kubernetes.io/docs/tasks/administer-cluster/kubeadm/kubeadm-upgrade/', 'Cluster Upgrade'],
  'helm': ['https://helm.sh/docs/', 'Helm'],
  'cni': ['https://kubernetes.io/docs/concepts/extend-kubernetes/compute-storage-net/network-plugins/', 'CNI'],
  'dns': ['https://kubernetes.io/docs/concepts/services-networking/dns-pod-service/', 'DNS'],
  'logs': ['https://kubernetes.io/docs/concepts/cluster-administration/logging/', 'Logging'],
  'events': ['https://kubernetes.io/docs/reference/kubectl/generated/kubectl_get/', 'kubectl get events'],
  'troubleshoot': ['https://kubernetes.io/docs/tasks/debug/', 'Troubleshooting'],
  'quota': ['https://kubernetes.io/docs/concepts/policy/resource-quotas/', 'Resource Quotas'],
  'limit': ['https://kubernetes.io/docs/concepts/policy/limit-range/', 'Limit Ranges'],
  'resource': ['https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/', 'Resource Management'],
  'sidecar': ['https://kubernetes.io/docs/concepts/workloads/pods/sidecar-containers/', 'Sidecar Containers'],
  'multi': ['https://kubernetes.io/docs/tasks/access-application-cluster/communicate-containers-same-pod-shared-volume/', 'Multi-container Pods'],
  'volume': ['https://kubernetes.io/docs/concepts/storage/volumes/', 'Volumes'],
  'static': ['https://kubernetes.io/docs/tasks/configure-pod-container/static-pod/', 'Static Pods'],
  'rollout': ['https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#rolling-back-a-deployment', 'Rollouts'],
  'rollback': ['https://kubernetes.io/docs/concepts/workloads/controllers/deployment/#rolling-back-a-deployment', 'Rollbacks'],
  'jsonpath': ['https://kubernetes.io/docs/reference/kubectl/jsonpath/', 'JSONPath'],
  'gateway': ['https://kubernetes.io/docs/concepts/services-networking/gateway/', 'Gateway API'],
  'clusterrole': ['https://kubernetes.io/docs/reference/access-authn-authz/rbac/#role-and-clusterrole', 'ClusterRole'],
  'rolebinding': ['https://kubernetes.io/docs/reference/access-authn-authz/rbac/#rolebinding-and-clusterrolebinding', 'RoleBindings'],
  'nodeport': ['https://kubernetes.io/docs/concepts/services-networking/service/#type-nodeport', 'NodePort'],
  'cert': ['https://kubernetes.io/docs/tasks/tls/managing-tls-in-a-cluster/', 'TLS Certificates'],
};

function getDocsForChallenge(challengeId, title, description) {
  const links = [];
  const text = (challengeId + ' ' + title + ' ' + description).toLowerCase();
  for (const [keyword, [url, label]] of Object.entries(docsMap)) {
    if (text.includes(keyword) && !links.find(l => l.url === url)) {
      links.push({ url, label });
    }
  }
  links.push({ url: 'https://kubernetes.io/docs/reference/kubectl/quick-reference/', label: 'kubectl Cheat Sheet' });
  return links.slice(0, 6);
}

function copyToClipboard(url, btn) {
  navigator.clipboard.writeText(url).then(() => {
    btn.textContent = '‚úì';
    btn.classList.add('copied');
    setTimeout(() => {
      btn.textContent = 'üìã';
      btn.classList.remove('copied');
    }, 1500);
  });
}

let sessionActive = false;

async function load() {
  try {
    const r = await fetch('api/status?ts='+Date.now());
    if (!r.ok) throw new Error('No session');
    const s = await r.json();
    
    sessionActive = true;
    document.getElementById('startBtn').style.display = 'none';
    document.getElementById('doneBtn').style.display = '';
    document.getElementById('nextBtn').style.display = '';
    document.getElementById('resetBtn').style.display = '';
    
    // Load desktop if not already loaded
    const frame = document.getElementById('desktopFrame');
    if (frame.src === 'about:blank' || !frame.src.includes('desktop')) {
      frame.src = 'desktop/';
    }
    
    const docs = getDocsForChallenge(s.challengeId, s.title, s.description || '');
    const docsHtml = docs.map(d => `
      <div class="doc-link">
        <span>üìñ</span>
        <span class="url" title="${d.url}">${d.label}</span>
        <button class="copy-btn" onclick="copyToClipboard('${d.url}', this)" title="Copy URL to paste in desktop browser">üìã</button>
      </div>
    `).join('');
    
    document.getElementById('challenge-panel').innerHTML = `
      <div class="challenge-section">
        <div class="challenge-title">${s.title}</div>
        <div class="challenge-meta">
          <span class="meta-item">ctx: <code>${s.context}</code></span>
          <span class="meta-item">ns: <code>${s.namespace}</code></span>
        </div>
        <div class="description-box">${s.description || 'No description available.'}</div>
      </div>
      <div class="section-title">üìö Documentation (click üìã to copy URL)</div>
      <div class="docs-links">${docsHtml}</div>
    `;
    
    document.getElementById('currentNum').textContent = (s.index || 0) + 1;
    document.getElementById('completedCount').textContent = s.completed || 0;
    document.getElementById('passedCount').textContent = s.passed || 0;
    
    const sStart = s.sessionStart ? new Date(s.sessionStart).getTime() : Date.now();
    const sLimit = (s.totalTimeLimitSeconds || 7200) * 1000;
    const sd = document.getElementById('sessionCountdown');
    
    function sessionTick() {
      const now = Date.now();
      const elapsed = now - sStart;
      const left = sLimit - elapsed;
      
      if (left <= 0) {
        sd.textContent = "‚è∞ Time's up!";
        sd.className = 'timer-value danger';
        return;
      }
      
      const hrs = Math.floor(left / 3600000);
      const mins = Math.floor((left % 3600000) / 60000);
      const secs = Math.floor((left % 60000) / 1000);
      sd.textContent = `${hrs}:${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
      
      if (left < 300000) { sd.className = 'timer-value danger'; }
      else if (left < 900000) { sd.className = 'timer-value warning'; }
      else { sd.className = 'timer-value ok'; }
      
      requestAnimationFrame(sessionTick);
    }
    sessionTick();
    
  } catch(e) {
    sessionActive = false;
    document.getElementById('startBtn').style.display = '';
    document.getElementById('doneBtn').style.display = 'none';
    document.getElementById('nextBtn').style.display = 'none';
    document.getElementById('resetBtn').style.display = 'none';
    document.getElementById('sessionCountdown').textContent = '2:00:00';
    document.getElementById('currentNum').textContent = '-';
    
    document.getElementById('challenge-panel').innerHTML = `
      <div class="no-session">
        <div class="icon">üöÄ</div>
        <h2>Ready to Practice?</h2>
        <p>Start a 2-hour timed session.<br>Complete as many challenges as you can!</p>
      </div>
    `;
    
    document.getElementById('desktopFrame').src = 'about:blank';
  }
}
load();

// Toggle sidebar
document.getElementById('toggleBtn').onclick = () => {
  const sidebar = document.getElementById('sidebar');
  const btn = document.getElementById('toggleBtn');
  sidebar.classList.toggle('collapsed');
  btn.textContent = sidebar.classList.contains('collapsed') ? '‚ñ∂' : '‚óÄ';
  btn.style.left = sidebar.classList.contains('collapsed') ? '0' : '380px';
};

async function post(path) {
  const res = await fetch(path, {method:'POST'});
  if (!res.ok) { throw new Error(await res.text()); }
  return res.json();
}

function showMsg(msg, isError=false) {
  const m = document.getElementById('actionMsg');
  const e = document.getElementById('errorMsg');
  if (isError) { e.textContent = msg; m.textContent = ''; }
  else { m.textContent = msg; e.textContent = ''; }
  setTimeout(() => { m.textContent = ''; e.textContent = ''; }, 5000);
}

function setButtonsDisabled(disabled) {
  ['startBtn', 'resetBtn', 'doneBtn', 'nextBtn'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.disabled = disabled;
  });
}

let resetInProgress = false;

document.getElementById('startBtn').onclick = async () => {
  if (resetInProgress) { showMsg('Please wait for reset...', true); return; }
  showMsg('Starting session...');
  try { 
    await post('api/start-session'); 
    showMsg('‚úì Session started! Good luck!'); 
    load(); 
  }
  catch(err) { showMsg('Failed to start: ' + err.message, true); }
};

document.getElementById('resetBtn').onclick = async () => {
  if (!confirm('Reset environment? This deletes and recreates clusters (~2 min).')) return;
  
  resetInProgress = true;
  setButtonsDisabled(true);
  
  let remaining = 120;
  const updateCountdown = () => {
    const mins = Math.floor(remaining / 60);
    const secs = remaining % 60;
    showMsg(`üîÑ Resetting... ${mins}:${secs.toString().padStart(2,'0')}`);
  };
  updateCountdown();
  const interval = setInterval(() => { remaining--; if (remaining >= 0) updateCountdown(); }, 1000);
  
  try {
    await post('api/reset');
    clearInterval(interval);
    showMsg('‚úì Environment reset!');
    load();
  }
  catch(err) {
    clearInterval(interval);
    showMsg('Failed: ' + err.message, true);
  }
  finally {
    resetInProgress = false;
    setButtonsDisabled(false);
  }
};

document.getElementById('doneBtn').onclick = async () => {
  if (resetInProgress) { showMsg('Please wait for reset...', true); return; }
  showMsg('Grading...');
  try { 
    await post('api/done'); 
    showMsg('‚úì Graded! Loading next...'); 
    setTimeout(load, 500);
  }
  catch(err) { showMsg('Failed: ' + err.message, true); }
};

document.getElementById('nextBtn').onclick = async () => {
  if (resetInProgress) { showMsg('Please wait for reset...', true); return; }
  showMsg('Loading next...');
  try { 
    await post('api/next-challenge'); 
    showMsg('‚úì Next challenge loaded!'); 
    load(); 
  }
  catch(err) { showMsg('Failed: ' + err.message, true); }
};
</script>
</body>
</html>
