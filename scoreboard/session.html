<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CKA Practice Session</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
  background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
  min-height: 100vh;
  color: #fff;
  padding: 2rem;
}
.container {
  max-width: 900px;
  margin: 0 auto;
}
.header {
  display: flex;
  align-items: center;
  gap: 1rem;
  margin-bottom: 1.5rem;
}
.header .logo { font-size: 2.5rem; }
h1 {
  font-size: 1.8rem;
  font-weight: 300;
}
h1 span { font-weight: 700; color: #326ce5; }
.card {
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 12px;
  padding: 1.5rem;
  margin-bottom: 1rem;
}
.card-title {
  font-size: 0.85rem;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: #888;
  margin-bottom: 1rem;
}
.info-row {
  display: flex;
  margin-bottom: 0.5rem;
}
.info-label {
  width: 140px;
  color: #888;
  flex-shrink: 0;
}
.info-value {
  color: #fff;
}
.info-value b { color: #326ce5; }
.description-box {
  background: rgba(0, 0, 0, 0.2);
  border-radius: 8px;
  padding: 1rem;
  margin-top: 1rem;
  font-family: 'Monaco', 'Menlo', monospace;
  font-size: 0.9rem;
  line-height: 1.6;
  white-space: pre-wrap;
  color: #ccc;
}
.timer-row {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 1rem;
}
.timer {
  flex: 1;
  min-width: 200px;
}
.timer-label {
  font-size: 0.85rem;
  color: #888;
  margin-bottom: 0.25rem;
}
.timer-value {
  font-size: 1.8rem;
  font-weight: 700;
  font-family: 'Monaco', 'Menlo', monospace;
}
.timer-value.warning { color: #f39c12; }
.timer-value.danger { color: #e74c3c; }
.timer-value.ok { color: #2ecc71; }
.actions {
  display: flex;
  flex-wrap: wrap;
  gap: 0.5rem;
  align-items: center;
}
.btn {
  padding: 0.75rem 1.5rem;
  font-size: 0.95rem;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  display: inline-block;
}
.btn-primary {
  background: linear-gradient(135deg, #326ce5 0%, #1e4db7 100%);
  color: #fff;
  box-shadow: 0 2px 10px rgba(50, 108, 229, 0.3);
}
.btn-primary:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 15px rgba(50, 108, 229, 0.4);
}
.btn-success {
  background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);
  color: #fff;
}
.btn-success:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
}
.btn-warning {
  background: linear-gradient(135deg, #f39c12 0%, #d68910 100%);
  color: #fff;
}
.btn-warning:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 15px rgba(243, 156, 18, 0.4);
}
.btn-secondary {
  background: rgba(255, 255, 255, 0.1);
  color: #fff;
  border: 1px solid rgba(255, 255, 255, 0.2);
}
.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.15);
}
.btn-danger {
  background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
  color: #fff;
}
.btn-danger:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 15px rgba(231, 76, 60, 0.4);
}
.btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none !important;
  box-shadow: none !important;
}
.link-btn {
  color: #326ce5;
  text-decoration: none;
  padding: 0.75rem 1rem;
  font-weight: 500;
}
.link-btn:hover { text-decoration: underline; }
.divider {
  color: #444;
  margin: 0 0.25rem;
}
.message {
  margin-top: 1rem;
  padding: 0.75rem 1rem;
  border-radius: 8px;
  font-size: 0.9rem;
}
.message.success {
  background: rgba(39, 174, 96, 0.2);
  border: 1px solid rgba(39, 174, 96, 0.3);
  color: #2ecc71;
}
.message.error {
  background: rgba(231, 76, 60, 0.2);
  border: 1px solid rgba(231, 76, 60, 0.3);
  color: #e74c3c;
}
.message:empty { display: none; }
.no-session {
  text-align: center;
  padding: 3rem;
  color: #888;
}
.no-session .icon { font-size: 3rem; margin-bottom: 1rem; }
.back-link {
  display: inline-block;
  margin-bottom: 1rem;
  color: #888;
  text-decoration: none;
  font-size: 0.9rem;
}
.back-link:hover { color: #326ce5; }
</style>
</head>
<body>
<div class="container">
  <a href="/" class="back-link">‚Üê Back to Home</a>
  
  <div class="header">
    <div class="logo">‚ò∏Ô∏è</div>
    <h1>CKA <span>Practice</span> Session</h1>
  </div>

  <div id="info" class="card">
    <div class="no-session">
      <div class="icon">üìã</div>
      <p>Loading session...</p>
    </div>
  </div>

  <div class="card">
    <div class="card-title">‚è±Ô∏è Time Remaining</div>
    <div class="timer-row">
      <div class="timer">
        <div class="timer-label">Challenge</div>
        <div class="timer-value ok" id="countdown">‚Äî</div>
      </div>
      <div class="timer">
        <div class="timer-label">Session Total</div>
        <div class="timer-value ok" id="sessionCountdown">‚Äî</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-title">üéÆ Actions</div>
    <div class="actions">
      <button id="startBtn" class="btn btn-primary">‚ñ∂ Start New Session</button>
      <button id="doneBtn" class="btn btn-success">‚úì Done (Grade)</button>
      <button id="nextBtn" class="btn btn-warning">‚Üí Next Challenge</button>
      <button id="syncBtn" class="btn btn-secondary">‚Üª Sync Scoreboard</button>
      <button id="resetBtn" class="btn btn-danger">‚ü≤ Reset</button>
      <span class="divider">|</span>
      <a href="desktop/" target="_blank" class="link-btn">üñ•Ô∏è Desktop</a>
      <a href="scoreboard/index.html" target="_blank" class="link-btn">üìä Scoreboard</a>
    </div>
    <div id="actionMsg" class="message success"></div>
    <div id="errorMsg" class="message error"></div>
  </div>
</div>

<script>
async function load() {
  try {
    const r = await fetch('api/status?ts='+Date.now());
    if (!r.ok) throw new Error('No session');
    const s = await r.json();
    const info = document.getElementById('info');
    info.innerHTML = `
      <div class="card-title">üìù Current Challenge</div>
      <div class="info-row"><span class="info-label">Challenge:</span><span class="info-value"><b>${s.challengeId}</b></span></div>
      <div class="info-row"><span class="info-label">Title:</span><span class="info-value">${s.title}</span></div>
      <div class="info-row"><span class="info-label">Namespace:</span><span class="info-value"><code>${s.namespace}</code></span></div>
      <div class="info-row"><span class="info-label">Context:</span><span class="info-value"><code>${s.context}</code></span></div>
      <div class="info-row"><span class="info-label">Time limit:</span><span class="info-value">${s.timeLimitSeconds} seconds</span></div>
      <div class="info-row"><span class="info-label">Progress:</span><span class="info-value"><b>${(s.index+1)||1}</b> / ${s.total||1} challenges</span></div>
      <div class="description-box">${s.description||'No description available.'}</div>
    `;
    const start = new Date(s.start).getTime();
    const limit = s.timeLimitSeconds*1000;
    const cd = document.getElementById('countdown');
    function tick(){
      const now = Date.now();
      const left = start + limit - now;
      if (left <= 0){ cd.textContent = '‚ö†Ô∏è Time exceeded'; cd.className='timer-value danger'; return; }
      const m = Math.floor(left/60000), sec = Math.floor((left%60000)/1000);
      cd.textContent = `${m}:${sec.toString().padStart(2,'0')}`;
      if (left < 60000) { cd.className='timer-value danger'; }
      else if (left < 180000) { cd.className='timer-value warning'; }
      else { cd.className='timer-value ok'; }
      requestAnimationFrame(tick);
    }
    tick();

    const sStart = s.sessionStart ? new Date(s.sessionStart).getTime() : null;
    const sLimit = s.totalTimeLimitSeconds ? s.totalTimeLimitSeconds*1000 : null;
    const sd = document.getElementById('sessionCountdown');
    function stick(){
      if (!sStart || !sLimit){ sd.textContent='‚Äî'; return; }
      const now = Date.now();
      const left = sStart + sLimit - now;
      if (left <= 0){ sd.textContent = '‚ö†Ô∏è Session ended'; sd.className='timer-value danger'; return; }
      const m = Math.floor(left/60000), sec = Math.floor((left%60000)/1000);
      sd.textContent = `${m}:${sec.toString().padStart(2,'0')}`;
      if (left < 300000) { sd.className='timer-value danger'; }
      else if (left < 600000) { sd.className='timer-value warning'; }
      else { sd.className='timer-value ok'; }
      requestAnimationFrame(stick);
    }
    stick();
  } catch(e) {
    document.getElementById('info').innerHTML = `
      <div class="no-session">
        <div class="icon">üöÄ</div>
        <p>No active session. Click <b>Start New Session</b> to begin your CKA practice!</p>
      </div>
    `;
  }
}
load();

async function post(path){
  const res = await fetch(path,{method:'POST'});
  if(!res.ok){ throw new Error(await res.text()); }
  return res.json();
}

function showMsg(msg, isError=false) {
  const m = document.getElementById('actionMsg');
  const e = document.getElementById('errorMsg');
  if (isError) { e.textContent = msg; m.textContent = ''; }
  else { m.textContent = msg; e.textContent = ''; }
}

function setButtonsDisabled(disabled) {
  ['startBtn', 'resetBtn', 'doneBtn', 'nextBtn', 'syncBtn'].forEach(id => {
    document.getElementById(id).disabled = disabled;
  });
}

let resetInProgress = false;

document.getElementById('startBtn').onclick = async ()=>{
  if (resetInProgress) { showMsg('Please wait for reset to complete...', true); return; }
  showMsg('Starting session...');
  try { await post('api/start-session'); showMsg('‚úì Session started!'); load(); }
  catch(err){ showMsg('Failed to start: '+err.message, true); }
};

document.getElementById('resetBtn').onclick = async ()=>{
  if (!confirm('Reset the environment? This will delete and recreate clusters (~2 minutes).')) return;
  
  resetInProgress = true;
  setButtonsDisabled(true);
  
  const RESET_TIME = 120; // seconds estimate
  let remaining = RESET_TIME;
  
  const updateCountdown = () => {
    const mins = Math.floor(remaining / 60);
    const secs = remaining % 60;
    showMsg(`üîÑ Resetting environment... ${mins}:${secs.toString().padStart(2,'0')} remaining`);
  };
  updateCountdown();
  
  const countdownInterval = setInterval(() => {
    remaining--;
    if (remaining >= 0) updateCountdown();
  }, 1000);
  
  try { 
    await post('api/reset'); 
    clearInterval(countdownInterval);
    showMsg('‚úì Environment reset complete! You can now start a new session.'); 
    load();
  }
  catch(err){ 
    clearInterval(countdownInterval);
    showMsg('Failed to reset: '+err.message, true); 
  }
  finally {
    resetInProgress = false;
    setButtonsDisabled(false);
  }
};

document.getElementById('doneBtn').onclick = async ()=>{
  if (resetInProgress) { showMsg('Please wait for reset to complete...', true); return; }
  showMsg('Grading challenge...');
  try { await post('api/done'); showMsg('‚úì Challenge graded! Check scoreboard for results.'); }
  catch(err){ showMsg('Failed to grade: '+err.message, true); }
};

document.getElementById('nextBtn').onclick = async ()=>{
  if (resetInProgress) { showMsg('Please wait for reset to complete...', true); return; }
  showMsg('Loading next challenge...');
  try { await post('api/next-challenge'); showMsg('‚úì Next challenge loaded!'); load(); }
  catch(err){ showMsg('Failed to load next: '+err.message, true); }
};

document.getElementById('syncBtn').onclick = async ()=>{
  if (resetInProgress) { showMsg('Please wait for reset to complete...', true); return; }
  showMsg('Syncing scoreboard...');
  try { await post('api/sync-scoreboard'); showMsg('‚úì Scoreboard synced!'); }
  catch(err){ showMsg('Failed to sync: '+err.message, true); }
};
</script>
</body>
</html>